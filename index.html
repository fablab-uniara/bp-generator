<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BP Generator - Debug Mode</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        .debug-console {
            background: #1a1a1a; color: #00ff00; 
            font-family: 'Courier New', monospace; font-size: 13px;
            padding: 15px; border-radius: 8px; margin-bottom: 20px;
            height: 200px; overflow-y: auto; border: 2px solid #333;
        }
        .log-error { color: #ff5555; font-weight: bold; }
        .log-warn { color: #ffff55; }
        .log-success { color: #55ff55; font-weight: bold; }
        .hidden { display: none !important; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">

    <div class="max-w-4xl mx-auto">
        
        <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
            <h2 class="text-xl font-bold text-gray-800 mb-2">üîß Painel de Diagn√≥stico</h2>
            <p class="text-sm text-gray-600 mb-4">Se o bot√£o de login n√£o funcionar, copie o erro abaixo e me mostre.</p>
            
            <div id="consoleBox" class="debug-console">
                > Iniciando sistema...<br>
            </div>

            <div class="flex gap-4">
                <button id="googleLoginBtn" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                    Entrar com Google
                </button>
                <button onclick="app.bypass()" class="text-gray-500 underline text-sm">
                    Modo Offline (Sem Google)
                </button>
            </div>
        </div>

        <div id="appArea" class="hidden bg-white p-8 rounded-xl shadow-lg">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h1 class="text-2xl font-bold text-blue-900">BP Generator UNIARA</h1>
                <div id="userInfo" class="text-sm text-gray-500">Modo Visitante</div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <nav class="space-y-2">
                    <button onclick="app.step(1)" class="w-full text-left p-2 rounded hover:bg-blue-50 font-medium">1. Identifica√ß√£o</button>
                    <button onclick="app.step(2)" class="w-full text-left p-2 rounded hover:bg-blue-50 font-medium">2. Mercado</button>
                    <button onclick="app.step(3)" class="w-full text-left p-2 rounded hover:bg-blue-50 font-medium">3. Financeiro</button>
                    <div class="h-4"></div>
                    <button onclick="app.save()" class="w-full bg-green-600 text-white p-2 rounded text-center">Salvar (Drive)</button>
                    <button onclick="app.pdf()" class="w-full bg-gray-700 text-white p-2 rounded text-center">Gerar PDF</button>
                </nav>

                <div class="col-span-3 bg-gray-50 p-6 rounded-lg border">
                    <h3 id="stepTitle" class="text-lg font-bold mb-4 text-blue-800">Bem-vindo</h3>
                    <div id="stepContent">
                        <p>Selecione uma etapa no menu ao lado para come√ßar.</p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // === 1. CONFIGURA√á√ÉO ===
        const CONFIG = {
            // SEU CLIENT ID AQUI
            clientId: '73623365605-79fuc56g2i857jqhhs0cluv5le75qrte.apps.googleusercontent.com',
            apiKey: 'AIzaSyAF7fB1NJZwUlpLGoSC50rsmLPgX_o3DPo',
            scope: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.profile',
            discovery: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"]
        };

        // Estado Global
        let tokenClient;
        let gapiInited = false;
        let gsiInited = false;
        let currentPlan = { name: '', data: {} };

        // === 2. LOGGER VISUAL (Para voc√™ ver o erro) ===
        function log(msg, type='info') {
            const box = document.getElementById('consoleBox');
            let colorClass = '';
            if(type === 'error') colorClass = 'log-error';
            if(type === 'success') colorClass = 'log-success';
            
            const time = new Date().toLocaleTimeString();
            box.innerHTML += `<div class="${colorClass}">[${time}] ${msg}</div>`;
            box.scrollTop = box.scrollHeight;
            console.log(`[${type}] ${msg}`);
        }

        // === 3. INICIALIZA√á√ÉO SEGURA ===
        function initSystem() {
            // Detecta a URL atual para ajudar na configura√ß√£o do Google
            const origin = window.location.origin;
            log(`üìç SUA ORIGEM ATUAL √â: ${origin}`, 'warn');
            log(`‚ö†Ô∏è Certifique-se de que EXATAMENTE esta URL (sem barra no final se n√£o tiver aqui) est√° nas "Origens JavaScript Autorizadas" no Google Cloud.`);

            loadScripts();
        }

        function loadScripts() {
            log("Baixando script GAPI...");
            const s1 = document.createElement('script');
            s1.src = "https://apis.google.com/js/api.js";
            s1.onload = () => {
                log("GAPI baixado. Inicializando...");
                gapi.load('client', initGapi);
            };
            s1.onerror = () => log("ERRO FATAL: N√£o foi poss√≠vel baixar GAPI.", 'error');
            document.body.appendChild(s1);

            log("Baixando script GSI...");
            const s2 = document.createElement('script');
            s2.src = "https://accounts.google.com/gsi/client";
            s2.onload = () => {
                log("GSI baixado. Inicializando...");
                initGsi();
            };
            s2.onerror = () => log("ERRO FATAL: N√£o foi poss√≠vel baixar GSI.", 'error');
            document.body.appendChild(s2);
        }

        async function initGapi() {
            try {
                await gapi.client.init({ apiKey: CONFIG.apiKey, discoveryDocs: CONFIG.discovery });
                gapiInited = true;
                log("‚úÖ GAPI Inicializado com sucesso.", 'success');
                checkReady();
            } catch (e) {
                log("‚ùå ERRO NO GAPI: " + JSON.stringify(e.result || e), 'error');
            }
        }

        function initGsi() {
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CONFIG.clientId,
                    scope: CONFIG.scope,
                    callback: '' // Ser√° definido no click
                });
                gsiInited = true;
                log("‚úÖ GSI Inicializado com sucesso.", 'success');
                checkReady();
            } catch (e) {
                log("‚ùå ERRO NO GSI: " + e.message, 'error');
            }
        }

        function checkReady() {
            if(gapiInited && gsiInited) {
                log("üöÄ SISTEMA PRONTO PARA LOGIN.", 'success');
                const btn = document.getElementById('googleLoginBtn');
                btn.disabled = false;
                btn.classList.add('animate-pulse'); // Efeito visual
            }
        }

        // === 4. LOGIN ===
        document.getElementById('googleLoginBtn').onclick = () => {
            log("Bot√£o clicado. Solicitando token...");
            
            tokenClient.callback = async (resp) => {
                if (resp.error) {
                    log("‚ùå ERRO DE LOGIN: " + resp.error, 'error');
                    return;
                }
                log("Token recebido! Carregando usu√°rio...", 'success');
                await loadUser();
                document.getElementById('appArea').classList.remove('hidden');
                // Esconde o debug se der tudo certo pra limpar a tela
                // document.getElementById('consoleBox').parentElement.classList.add('hidden');
            };

            // For√ßa o prompt se estiver dando erro de popup
            tokenClient.requestAccessToken({prompt: 'consent'});
        };

        async function loadUser() {
            try {
                const resp = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
                    headers: { Authorization: `Bearer ${gapi.client.getToken().access_token}` }
                });
                const user = await resp.json();
                document.getElementById('userInfo').innerText = `Logado como: ${user.name}`;
                log(`Usu√°rio identificado: ${user.name}`);
            } catch (e) { log("Erro ao pegar dados do usu√°rio.", 'error'); }
        }

        // === 5. APP L√ìGICA (Simplificada para teste) ===
        const app = {
            bypass: () => {
                log("Modo Offline ativado.");
                document.getElementById('appArea').classList.remove('hidden');
            },
            step: (num) => {
                const title = document.getElementById('stepTitle');
                const content = document.getElementById('stepContent');
                
                if(num === 1) {
                    title.innerText = "1. Identifica√ß√£o";
                    content.innerHTML = `
                        <label class="block font-bold mb-1">Nome do Neg√≥cio</label>
                        <input type="text" class="w-full border p-2 rounded mb-4" onchange="currentPlan.name = this.value">
                        <label class="block font-bold mb-1">Miss√£o</label>
                        <textarea class="w-full border p-2 rounded h-24"></textarea>
                    `;
                } else if(num === 2) {
                    title.innerText = "2. Mercado";
                    content.innerHTML = `<p>Conte√∫do de Mercado aqui...</p>`;
                } else {
                    title.innerText = "3. Financeiro";
                    content.innerHTML = `<p>Conte√∫do Financeiro aqui...</p>`;
                }
            },
            save: async () => {
                if(!gapi.client.getToken()) return alert("Voc√™ precisa estar logado para salvar no Drive!");
                log("Tentando salvar arquivo...");
                try {
                    const fileContent = JSON.stringify(currentPlan);
                    const file = new Blob([fileContent], {type: 'application/json'});
                    const metadata = {
                        'name': `UNIARA_BP_${currentPlan.name || 'SemNome'}.json`,
                        'mimeType': 'application/json'
                    };

                    const formData = new FormData();
                    formData.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
                    formData.append('file', file);

                    await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                        method: 'POST',
                        headers: { 'Authorization': 'Bearer ' + gapi.client.getToken().access_token },
                        body: formData
                    });
                    alert("Salvo com sucesso!");
                    log("Arquivo salvo no Drive.", 'success');
                } catch(e) {
                    log("Erro ao salvar: " + e.message, 'error');
                    alert("Erro ao salvar.");
                }
            },
            pdf: () => {
                const el = document.getElementById('stepContent');
                html2pdf().from(el).save('Plano.pdf');
            }
        };

        // Start
        window.onload = initSystem;

    </script>
</body>
</html>
